import Request from"./request";import _ from"lodash-es";import cache from"./cache";import Layout from"../base/layout";import Developing from"../base/views/error/ErrDev";let Starter={$router:null,$store:null,$settings:null,install:function(e,t){const{store:r,router:n,settings:o,socket:a}=t,i=(Starter.$router=n,Starter.$store=r,Starter.$settings=o,e.config.globalProperties.$LS=_,Starter.$settings.elementUI&&(e.config.globalProperties.$ELEMENT={size:Starter.$settings.elementUI.size||"",zIndex:Starter.$settings.elementUI.zIndex||2e3}),Starter.$settings.socket.enable&&a&&e.use(a,Starter.$settings.socket.service),Starter.$settings&&(Request.registerRequest(Starter.$settings),e.config.globalProperties.$HTTP=Request,window.$HTTP=Request),e.config.globalProperties.$SETTINGS=Starter.$settings,window.$SETTINGS=Starter.$settings,"token"),l=["/login","/register","/forgot-passoword"];Starter.$router.beforeEach(async(e,t,r)=>{cache.setLS(i,"wenso-token");var o=cache.getLS(i);if(console.log(Starter.$store.getters["base/routes"].length),o){if(import.meta.env.VITE_SSO_CENTER){if(e.query.redirect)return void(window.location.href=e.query.redirect);if(import.meta.env.VITE_HOMEPAGE_URL&&import.meta.env.VITE_PLATFORM_URL!==import.meta.env.VITE_HOMEPAGE_URL)return void(window.location.href=import.meta.env.VITE_HOMEPAGE_URL)}if("/login"===e.path)r({path:"/"});else if("/logout"===e.path)location.reload();else if(Starter.$store.getters["base/routes"].length)r();else try{await Starter.$store.dispatch("base/getUserProfile");const a=await Starter.$store.dispatch("base/getRouterList");a.forEach(e=>{n.addRoute(e)}),r({...e,replace:!0})}catch(e){await Starter.$store.dispatch("base/cleanToken"),location.reload()}}else l.includes(e.path)?"/login"===e.path&&import.meta.env.VITE_SSO_CENTER?location.href=e.query.redirect?import.meta.env.VITE_PLATFORM_URL+"/login?redirect="+e.query.redirect:import.meta.env.VITE_PLATFORM_URL+"/login":r():import.meta.env.VITE_SSO_CENTER?location.href=import.meta.env.VITE_PLATFORM_URL+"/login?redirect="+import.meta.env.VITE_HOMEPAGE_URL:r("/login")}),Starter.$router.afterEach(()=>{}),e.use(Starter.$store),e.use(Starter.$router)},build:{formatRouter:(e,t)=>{var r={path:"/",name:"home",redirect:e.homePage,hidden:!0},o=[];let a=e.router.config.catalog;t=t.filter(e=>{if(0===e.meta.menuType)return Object.prototype.hasOwnProperty.call(a,e.path)});Starter.build.buildChildrenMenu(e,t,o),Starter.build.setLocalComponent(),Starter.build.clearChildren(t);let n=e.authRouters;return n.push({path:"/:pathMatch(.*)",redirect:"/err",hidden:!0}),n.push(r),{routes:t,allRoutes:n.concat(t),buttons:o}},clearChildren:t=>{for(let e=0;e<t.length;e++)t[e].meta&&Object.prototype.hasOwnProperty.call(t[e].meta,"menuType")&&0===t[e].meta.menuType&&t[e].children&&(0<t[e].children.length&&Starter.build.clearChildren(t[e].children),0===t[e].children.length&&(t.splice(e,1),e--))},buildChildrenMenu:(r,o,a)=>{let n=o.length;for(let t=0;t<n;t++){let e=o[t];var i=e.path;switch(e.meta.menuType){case 0:var l=r.router.config.catalog[i];void 0===l||""===i?(o.splice(t,1),t--,n--):(e.component=Layout,e.meta.icon=void 0===l?l.icon:"");break;case 1:l=r.router.config.menu[i];void 0===l?(o.splice(t,1),t--,n--):(e.component=l&&l.component?l.component:Developing,e.target=l&&l.target?l.target:"blank");break;case 2:var s=r.router.config.button[i];a.push(e),void 0===s?(o.splice(t,1),t--,n--):(e.component=s&&s.component?s.component:Developing,e.target=s&&s.target?s.target:"blank")}void 0!==e&&Object.prototype.hasOwnProperty.call(e,"children")&&e.children&&Starter.build.buildChildrenMenu(r,e.children,a)}},setLocalComponent:()=>{}}};export default Starter;